import { Meta } from '@storybook/addon-docs';

<Meta
  title="Guides/Links and Images"
  parameters={{
    viewMode: 'docs',
    previewTabs: {
      canvas: { hidden: true },
    },
  }}
/>

# Using GatsbyLink and NextLink with `ParseUrl`

[GatsbyLink](https://www.gatsbyjs.com/docs/reference/built-in-components/gatsby-link/) and
[NextLink](https://nextjs.org/docs/api-reference/next/link) are powerful tools for fast internal navigation. However,
they typically take relative paths for their href value, and in Gatsby's case this is actually required. Relative paths
are inconvenient when operating with URLs from a CMS because it reduces your opportunities for effective validation and
can become inconsistently implemented. Instead, it's easier to require a full URL for all links, both internal and
external, then have a function to read the URL and create a relative path from it if possible, and use a standard `<a>`
tag with a full URL if not. This is exactly what `parseURL` accomplishes. To use it:

1. Navigate to `utils/parseUrl.ts`
2. Replace `'localhost'` with your website's domain name. Do **not** include `www`. An example is shown for
   [webstacks.com](https://www.webstacks.com/).
3. In the `as` key of the returned object, replace the first `'a'` with your framework's link component. An example is
   shown with `GatsbyLink`.

```ts
// utils/parseUrl.ts

import { Link as GatsbyLink } from 'gatsby';

export const parseUrl = (href: string) => {
  const domain = 'webstacks.com';
  const url = new URL(href);
  const isInternalLink = url.hostname === `www.${domain}` || url.hostname === domain;

  return {
    as: isInternalLink ? GatsbyLink : ('a' as const),
    to: isInternalLink ? url.href.split(url.host)[1] : undefined,
    rel: isInternalLink ? '' : 'noreferrer noopener',
    target: isInternalLink ? '' : '_blank',
    href,
  };
};
```

The [Button](?path=/story/molecules-buttons--contained) molecule and [Link](?path=/story/quarks-link--link) quark
already implement `parseUrl`, so there is no need to add it anywhere immediately.

# Using GatsbyImage and NextImage

Likewise, Gatsby and NextJS both offer their own image components designed to allow for automatic asset optimization,
lazy loading, and other valuable features. As each one works differently, we've included files for both with the code
commented out.

This library includes 3 image files in the "quarks" directory.

1. Image-Gatsby.tsx
2. Image-Next.tsx
3. Image.tsx - a default/fallback.

To use the one for your respective framework, simply delete the other two and rename the one corresponding with your
framework to "Image.tsx" so that all imports matching that path resolve to it. Then delete the `export default null;`
line at the top and uncomment the code. Now you have a working image quark.

## Setting up gatsby-plugin-image.

**Important:** This library uses [gatsby-plugin-image](https://www.gatsbyjs.com/plugins/gatsby-plugin-image/), not the
deprecated gatsby-image one.

This plugin needs to be installed separately from Gatsby:

```shell
yarn add gatsby-plugin-image gatsby-plugin-sharp gatsby-source-filesystem gatsby-transformer-sharp
```

Then, create a `gatsby-config.js` file in your root directory and add the associated plugins there:

```js
// gatsby-config.js

module.exports = {
  plugins: [`gatsby-plugin-image`, `gatsby-plugin-sharp`, `gatsby-transformer-sharp`],
};
```

## Setting up next/image

[next/image](https://nextjs.org/docs/api-reference/next/image) requires you to explicitly approve the domains you use
with it. To do so, create a `next.config.js` file in your root directory and add your CMS's content delivery network
(CDN) as below. The example below uses Contentful's CDN.

```js
// next.config.js

module.exports = {
  images: {
    domains: ['images.ctfassets.net'],
  },
};
```

#### next/image Storybook

To support next/image in the storybook builds I need to add the `unoptimized` prop to its existing arguments on the
`quarks/storybook/Image.stories.tsx` file.

```js
//quarks/storybook/Image.stories.tsx

image.args = {
  unoptimized: true,
  src: './blurBackground.jpg',
  width: '700px',
  height: 'auto',
  alt: '',
};
```
